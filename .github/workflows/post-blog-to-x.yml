# When you push new or changed blog posts to main, post a summary to X (Twitter).
# Add these repo secrets: X_API_KEY, X_API_SECRET, X_ACCESS_TOKEN, X_ACCESS_TOKEN_SECRET
# Optional: BASE_URL (e.g. https://yourdomain.com) for the blog post link

name: Post new blog to X

on:
  push:
    branches:
      - main
    paths:
      - 'docs/blog/posts/**'

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed blog posts
        id: changed
        run: |
          # Skip initial push (no previous commit)
          BEFORE="${{ github.event.before }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial push; skipping X post."
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi
          FILES=$(git diff --name-only "$BEFORE" "${{ github.sha }}" -- docs/blog/posts/ | tr '\n' ' ' || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT
          if [ -z "$FILES" ]; then
            echo "No blog post files changed."
          else
            echo "Changed: $FILES"
          fi

      - name: Setup Node
        if: steps.changed.outputs.files != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.changed.outputs.files != ''
        run: npm ci

      - name: Post to X
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          BASE_URL: ${{ secrets.BASE_URL }}
        run: node scripts/post-to-x.js
